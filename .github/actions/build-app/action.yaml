name: Build dcspy binary packages
description: Assembles the full dcspy application.
runs:
  using: composite
  steps:
    - name: Choco help
      uses: crazy-max/ghaction-chocolatey@v2
      with:
        args: install -y visualstudio2022-workload-vctools
        cache: vs2022

    - name: Compile and install PyInstaller
      shell: powershell
      run: |
        ./venv/scripts/activate
        Write-Output "Clone PyInstaller"
        git clone https://github.com/pyinstaller/pyinstaller.git
        cd pyinstaller
        git checkout v5.10.1
        cd bootloader
        Write-Output "Bulid WAF"
        python.exe ./waf all
        cd ..
        Write-Output "Build package wheel"
        python.exe setup.py bdist_wheel
        Get-ChildItem dist
        Write-Output "Pip List"
        pip list
        Write-Output "Install PyInstaller"
        pip install  dist\pyinstaller-5.10.1-py3-none-any.whl

    - name: Make version file
      shell: powershell
      run: |
        pip list
        Get-ChildItem .
        ./venv/scripts/activate
        pip list
        python gnerate_ver_file.py $env:GITHUB_REF_NAME $env:GITHUB_RUN_NUMBER $env:GITHUB_SHA file_version_info.txt

    - name: Build regular binary
      shell: powershell
      run: |
        Get-ChildItem .
        ./venv/scripts/activate
        pyinstaller --clean --noconfirm --log-level INFO dcspy.spec

    - name: Build CLI binary
      shell: powershell
      run: |
        ./venv/scripts/activate
        pyinstaller --clean --noconfirm --log-level INFO dcspy_cli.spec

    - name: Install changelog
      shell: powershell
      run: |
        Copy-Item .\CHANGELOG.md .\dist
